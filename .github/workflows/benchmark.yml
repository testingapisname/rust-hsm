name: Benchmark

on:
  push:
    branches: [ main ]
    paths:
      - 'crates/rust-hsm-cli/src/**'
      - 'crates/rust-hsm-core/src/**'
      - '.github/workflows/benchmark.yml'
  schedule:
    # Run weekly on Sunday at 2am UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for gh-pages branch creation
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: docker compose build
      
      - name: Start container
        run: docker compose up -d
      
      - name: Wait for container to be ready
        run: sleep 10
      
      - name: Initialize test token using rust-hsm-cli
        run: |
          docker exec rust-hsm-app rust-hsm-cli init-token \
            --label BENCH_TOKEN --so-pin 12345678
          docker exec rust-hsm-app rust-hsm-cli init-pin \
            --label BENCH_TOKEN --so-pin 12345678 --user-pin 123456
      
      - name: Run benchmark with rust-hsm-cli
        run: |
          docker exec rust-hsm-app rust-hsm-cli benchmark \
            --label BENCH_TOKEN --user-pin 123456 \
            --iterations 50 --warmup 5 \
            --format json --output /app/benchmark-results.json \
            --data-sizes
      
      - name: Copy benchmark results
        run: |
          # Copy the main results file
          docker cp rust-hsm-app:/app/benchmark-results.json ./benchmark-results.json
          
          # Copy GitHub Actions format file (automatically generated by rust-hsm-cli)
          docker cp rust-hsm-app:/app/benchmark-results-gh.json ./benchmark-results-gh.json
          
          # Verify files exist and show samples
          echo "=== Main benchmark results ==="
          head -20 benchmark-results.json
          
          echo "=== GitHub Actions format ==="
          head -20 benchmark-results-gh.json
      
      - name: Setup gh-pages branch if needed
        run: |
          git config --global user.name 'github-action-benchmark'
          git config --global user.email 'github@users.noreply.github.com'
          
          # Check if gh-pages exists remotely
          if ! git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# HSM Performance Benchmarks" > README.md
            echo "" >> README.md
            echo "Automated benchmark results for rust-hsm PKCS#11 operations." >> README.md
            echo "" >> README.md
            echo "Generated by [github-action-benchmark](https://github.com/benchmark-action/github-action-benchmark)." >> README.md
            git add README.md
            git commit -m "Initialize gh-pages branch for benchmarks"
            git push origin gh-pages
            git checkout main
            echo "âœ“ Created gh-pages branch"
          else
            echo "âœ“ gh-pages branch already exists"
          fi
      
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: 'HSM Performance Benchmarks'
          tool: 'customBiggerIsBetter'  # ops/sec - higher is better
          output-file-path: benchmark-results-gh.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Show alert with commit comment on detecting possible performance regression
          alert-threshold: '150%'  # Alert if performance degrades by 50%
          comment-on-alert: true
          fail-on-alert: false
          alert-comment-cc-users: '@testingapisname'
      
      - name: Upload benchmark results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results.json
            benchmark-results-gh.json
      
      - name: Display benchmark summary
        run: |
          echo "=== Benchmark Summary ==="
          if [ -f benchmark-results.json ]; then
            jq -r '.results[]? | "\(.result.name): \(.ops_per_sec | round) ops/sec"' benchmark-results.json || echo "Could not parse results"
          else
            echo "No benchmark results file found"
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('benchmark-results.json')) {
              console.log('No benchmark results file found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('benchmark-results.json', 'utf8'));
            
            let comment = '## ðŸ“Š Benchmark Results\n\n';
            comment += '| Operation | Ops/sec | Avg (ms) | P95 (ms) | P99 (ms) |\n';
            comment += '|-----------|---------|----------|----------|----------|\n';
            
            if (results.results) {
              results.results.forEach(r => {
                const name = r.result?.name || 'Unknown';
                const ops = (r.ops_per_sec || 0).toFixed(1);
                const avg = (r.avg_latency_ms || 0).toFixed(2);
                const p95 = (r.p95_ms || 0).toFixed(2);
                const p99 = (r.p99_ms || 0).toFixed(2);
                comment += `| ${name} | ${ops} | ${avg} | ${p95} | ${p99} |\n`;
              });
            } else {
              comment += '| No results available | - | - | - | - |\n';
            }
            
            comment += '\nðŸ“ˆ [View historical results](https://testingapisname.github.io/rust-hsm/dev/bench/)\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Stop container
        if: always()
        run: |
          docker compose down
          docker volume prune -f